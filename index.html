<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¨ã—æ´»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#f472b6;
      --pill:#2a1d2d;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --radius:22px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      color:var(--text);
      background:transparent;
    }
    .wrap{ max-width:520px; margin:0 auto; }
    .card{
      background:
        radial-gradient(1200px 500px at 20% -30%, rgba(244,114,182,.25), transparent 60%),
        radial-gradient(900px 500px at 120% 0%, rgba(244,114,182,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)),
        var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .title{
      font-size:13px;
      letter-spacing:.08em;
      color:var(--muted);
      margin:2px 0 12px;
      font-weight:700;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-radius:18px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      margin-bottom:12px;
      min-height:74px;
    }
    .left{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:0;
    }
    .icon{
      width:36px; height:36px;
      border-radius:12px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
      font-size:18px;
    }
    .meta{ min-width:0; }
    .label{
      font-size:18px;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .date{
      margin-top:4px;
      font-size:14px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      flex:0 0 auto;
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      background:rgba(244,114,182,.12);
      border:1px solid rgba(244,114,182,.35);
      color:var(--text);
      min-width:92px;
      text-align:center;
    }
    .pill.today{
      background:rgba(34,197,94,.14);
      border-color:rgba(34,197,94,.45);
    }
    .pill.past{
      background:rgba(148,163,184,.10);
      border-color:rgba(148,163,184,.25);
      color:var(--muted);
    }
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }
    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
    }
    button:hover{ background:rgba(255,255,255,.09); }
    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    code{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:2px 6px;
      border-radius:8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="title">æ¨ã—æ´»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ</div>

      <!-- æ¨ã—èª•ç”Ÿæ—¥ -->
      <div class="row">
        <div class="left">
          <div class="icon">ğŸ‚</div>
          <div class="meta">
            <div class="label" id="bLabel">æ¨ã—èª•ç”Ÿæ—¥ï¼ˆæ¨ã—ï¼‰</div>
            <div class="date" id="bDateText">â€”</div>
          </div>
        </div>
        <div class="pill" id="bCountdown">â€”</div>
      </div>

      <!-- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ -->
      <div class="row">
        <div class="left">
          <div class="icon">â³</div>
          <div class="meta">
            <div class="label" id="eLabel">æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ</div>
            <div class="date" id="eDateText">â€”</div>
          </div>
        </div>
        <div class="pill" id="eCountdown">â€”</div>
      </div>

      <div class="footer">
        <span id="nowText">æ›´æ–°: â€”</span>
        <button id="editBtn" type="button">æ—¥ä»˜ã‚’å¤‰æ›´</button>
      </div>

      <div class="hint">
        ä¾‹ï¼‰ã‚¤ãƒ™ãƒ³ãƒˆå…¥åŠ›ã¯ <code>ã‚¤ãƒ™ãƒ³ãƒˆå@YYYY-MM-DD</code> ã‚’æ”¹è¡Œã§è¤‡æ•°OKğŸ§¡
      </div>
    </div>
  </div>

  <script>
    // =========================
    // æ¨ã—æ´»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆindexå®Œçµãƒ»ç¢ºå®Ÿã«å‹•ãç‰ˆï¼‰
    // - æ¬¡ã®è©¦åˆ â†’ æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    // - æ—¥ä»˜ã¯ localStorage ã«ä¿å­˜ï¼ˆãƒœã‚¿ãƒ³ã§éšæ™‚æ›´æ–°ï¼‰
    // - è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ã€Œæœªæ¥ã§æœ€ã‚‚è¿‘ã„ã‚‚ã®ã€ã‚’è‡ªå‹•è¡¨ç¤º
    // =========================

    const LOCALE = "ja-JP";
    const TIMEZONE = "Asia/Tokyo";
    const STORAGE_KEY = "oshi_widget_data_v1";

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆåˆå›ã ã‘ä½¿ã‚ã‚Œã‚‹ã€‚ä»¥å¾Œã¯ãƒœã‚¿ãƒ³æ›´æ–°å†…å®¹ãŒå„ªå…ˆï¼‰
    const DEFAULT_DATA = {
      oshiName: "æ¨ã—",
      birthday: "2000-08-06", // å¹´ã¯ä»®ã§OKï¼ˆæ¯å¹´ã®æ¬¡ã®èª•ç”Ÿæ—¥ã‚’è¨ˆç®—ï¼‰
      events: [
        { name: "æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ", date: "2026-01-05" }
      ]
    };

    const $ = (id) => document.getElementById(id);

    // timezoneã‚ºãƒ¬ã‚’é¿ã‘ã‚‹ãŸã‚ã€ŒUTCæ­£åˆã€ã§æ‰±ã†
    function parseYMD(ymd) {
      const [y, m, d] = String(ymd).split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
    }

    function tokyoTodayUTCNoon() {
      const now = new Date();
      const parts = new Intl.DateTimeFormat(LOCALE, {
        timeZone: TIMEZONE,
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      }).formatToParts(now);

      const y = parts.find(p => p.type === "year")?.value;
      const m = parts.find(p => p.type === "month")?.value;
      const d = parts.find(p => p.type === "day")?.value;
      return parseYMD(`${y}-${m}-${d}`);
    }

    function daysDiff(fromUTCNoon, toUTCNoon) {
      return Math.round((toUTCNoon - fromUTCNoon) / (1000 * 60 * 60 * 24));
    }

    function formatDate(ymd) {
      const dt = parseYMD(ymd);
      return new Intl.DateTimeFormat(LOCALE, {
        timeZone: TIMEZONE,
        year: "numeric",
        month: "long",
        day: "numeric",
        weekday: "short"
      }).format(dt);
    }

    function setPill(el, diff) {
      el.classList.remove("today", "past");
      if (diff === 0) {
        el.textContent = "ğŸ‰ ä»Šæ—¥ï¼";
        el.classList.add("today");
      } else if (diff > 0) {
        el.textContent = `ã‚ã¨ ${diff}æ—¥`;
      } else {
        el.textContent = `${Math.abs(diff)}æ—¥ çµŒé`;
        el.classList.add("past");
      }
    }

    function safeClone(obj) {
      // structuredClone éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®ä¿é™º
      try { return structuredClone(obj); } catch { return JSON.parse(JSON.stringify(obj)); }
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return safeClone(DEFAULT_DATA);
        const parsed = JSON.parse(raw);

        if (!parsed.oshiName) parsed.oshiName = DEFAULT_DATA.oshiName;
        if (!parsed.birthday) parsed.birthday = DEFAULT_DATA.birthday;
        if (!Array.isArray(parsed.events)) parsed.events = safeClone(DEFAULT_DATA.events);

        // eventsã®æ•´å½¢
        parsed.events = parsed.events
          .filter(ev => ev && typeof ev === "object")
          .map(ev => ({
            name: (ev.name || "æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ").trim(),
            date: (ev.date || "").trim()
          }));

        return parsed;
      } catch {
        return safeClone(DEFAULT_DATA);
      }
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function nextBirthday(birthdayYMD, baseDateUTCNoon) {
      const parts = String(birthdayYMD).split("-").map(Number);
      const mm = parts[1];
      const dd = parts[2];

      const yearNow = Number(new Intl.DateTimeFormat(LOCALE, {
        timeZone: TIMEZONE,
        year: "numeric"
      }).format(new Date()));

      let target = new Date(Date.UTC(yearNow, mm - 1, dd, 12, 0, 0));
      if (daysDiff(baseDateUTCNoon, target) < 0) {
        target = new Date(Date.UTC(yearNow + 1, mm - 1, dd, 12, 0, 0));
      }

      const y = target.getUTCFullYear();
      const m = String(target.getUTCMonth() + 1).padStart(2, "0");
      const d = String(target.getUTCDate()).padStart(2, "0");
      return { ymd: `${y}-${m}-${d}`, dt: target };
    }

    function pickNearestUpcomingEvent(events, baseDateUTCNoon) {
      let bestFuture = null;
      let bestPast = null;

      for (const ev of events) {
        if (!ev?.date || !/^\d{4}-\d{2}-\d{2}$/.test(ev.date)) continue;

        const dt = parseYMD(ev.date);
        const diff = daysDiff(baseDateUTCNoon, dt);

        if (diff >= 0) {
          if (!bestFuture || diff < bestFuture.diff) bestFuture = { ...ev, dt, diff };
        } else {Â Â Â Â Â Â Â Â Â Â 
          if (!bestPast || diff > bestPast.diff) bestPast = { ...ev, dt, diff };
        }
      }
      return bestFuture || bestPast || null;
    }

    function render() {
      const base = tokyoTodayUTCNoon();
      const data = loadData();

      // èª•ç”Ÿæ—¥
      $("bLabel").textContent = `æ¨ã—èª•ç”Ÿæ—¥ï¼ˆ${data.oshiName || "æ¨ã—"}ï¼‰`;
      const bTarget = nextBirthday(data.birthday, base);
      $("bDateText").textContent = formatDate(bTarget.ymd);
      setPill($("bCountdown"), daysDiff(base, bTarget.dt));

      // æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      const ev = pickNearestUpcomingEvent(data.events || [], base);
      $("eLabel").textContent = ev?.name || "æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ";
      $("eDateText").textContent = ev?.date ? formatDate(ev.date) : "â€”";
      setPill($("eCountdown"), ev ? ev.diff : 0);

      // æ›´æ–°æ™‚åˆ»
      cons
